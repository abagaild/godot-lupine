#include "platformer_elements_module.h"

void PlatformerElementsModule::generate_script(Ref<FileAccess> p_file) {
	String filename = p_file->get_path().get_file();
	
	if (filename == "PlatformerTile.gd") {
		p_file->store_line("# PlatformerTile.gd");
		p_file->store_line("# Generated by Lupine Engine - Base Platformer Tile");
		p_file->store_line("# Base class for all platformer tiles and elements");
		p_file->store_line("");
		p_file->store_line("extends StaticBody2D");
		p_file->store_line("class_name PlatformerTile");
		p_file->store_line("");
		p_file->store_line("# Tile properties");
		p_file->store_line("@export var tile_type: String = \"ground\"");
		p_file->store_line("@export var is_solid: bool = true");
		p_file->store_line("@export var is_one_way: bool = false");
		p_file->store_line("@export var damage_amount: float = 0.0");
		p_file->store_line("");
		p_file->store_line("# Components");
		p_file->store_line("@onready var sprite: Sprite2D = $Sprite2D");
		p_file->store_line("@onready var collision: CollisionShape2D = $CollisionShape2D");
		p_file->store_line("");
		p_file->store_line("func _ready():");
		p_file->store_line("\tif is_one_way:");
		p_file->store_line("\t\tcollision_layer = 2  # One-way platform layer");
		p_file->store_line("");
		p_file->store_line("func interact_with_player(player: Node):");
		p_file->store_line("\t# Override in derived classes");
		p_file->store_line("\tpass");
	} else if (filename == "SpikeTile.gd") {
		p_file->store_line("# SpikeTile.gd");
		p_file->store_line("# Generated by Lupine Engine - Spike Hazard");
		p_file->store_line("# Damaging spike tile");
		p_file->store_line("");
		p_file->store_line("extends PlatformerTile");
		p_file->store_line("");
		p_file->store_line("@export var spike_damage: float = 25.0");
		p_file->store_line("@export var knockback_force: float = 200.0");
		p_file->store_line("");
		p_file->store_line("@onready var damage_area: Area2D = $DamageArea");
		p_file->store_line("");
		p_file->store_line("func _ready():");
		p_file->store_line("\tsuper._ready()");
		p_file->store_line("\tdamage_amount = spike_damage");
		p_file->store_line("\tif damage_area:");
		p_file->store_line("\t\tdamage_area.body_entered.connect(_on_player_touched)");
		p_file->store_line("");
		p_file->store_line("func _on_player_touched(body: Node):");
		p_file->store_line("\tif body.has_method(\"take_damage\"):");
		p_file->store_line("\t\tvar knockback = Vector2(0, -knockback_force)");
		p_file->store_line("\t\tbody.take_damage(spike_damage, knockback)");
	} else if (filename == "BouncePlate.gd") {
		p_file->store_line("# BouncePlate.gd");
		p_file->store_line("# Generated by Lupine Engine - Bounce Plate");
		p_file->store_line("# Platform that bounces the player upward");
		p_file->store_line("");
		p_file->store_line("extends PlatformerTile");
		p_file->store_line("");
		p_file->store_line("@export var bounce_force: float = 600.0");
		p_file->store_line("@export var bounce_sound: AudioStream");
		p_file->store_line("");
		p_file->store_line("@onready var bounce_area: Area2D = $BounceArea");
		p_file->store_line("@onready var audio_player: AudioStreamPlayer2D = $AudioStreamPlayer2D");
		p_file->store_line("@onready var animation_player: AnimationPlayer = $AnimationPlayer");
		p_file->store_line("");
		p_file->store_line("func _ready():");
		p_file->store_line("\tsuper._ready()");
		p_file->store_line("\tif bounce_area:");
		p_file->store_line("\t\tbounce_area.body_entered.connect(_on_player_bounced)");
		p_file->store_line("");
		p_file->store_line("func _on_player_bounced(body: Node):");
		p_file->store_line("\tif body.has_method(\"apply_bounce\"):");
		p_file->store_line("\t\tbody.apply_bounce(Vector2(0, -bounce_force))");
		p_file->store_line("\t\t");
		p_file->store_line("\t\t# Play effects");
		p_file->store_line("\t\tif audio_player and bounce_sound:");
		p_file->store_line("\t\t\taudio_player.stream = bounce_sound");
		p_file->store_line("\t\t\taudio_player.play()");
		p_file->store_line("\t\t");
		p_file->store_line("\t\tif animation_player:");
		p_file->store_line("\t\t\tanimation_player.play(\"bounce\")");
	} else if (filename == "FlameThrower.gd") {
		p_file->store_line("# FlameThrower.gd");
		p_file->store_line("# Generated by Lupine Engine - Flame Thrower Hazard");
		p_file->store_line("# Periodic flame hazard");
		p_file->store_line("");
		p_file->store_line("extends PlatformerTile");
		p_file->store_line("");
		p_file->store_line("@export var flame_damage: float = 30.0");
		p_file->store_line("@export var flame_duration: float = 2.0");
		p_file->store_line("@export var flame_cooldown: float = 3.0");
		p_file->store_line("@export var warning_time: float = 1.0");
		p_file->store_line("");
		p_file->store_line("@onready var flame_area: Area2D = $FlameArea");
		p_file->store_line("@onready var warning_sprite: Sprite2D = $WarningSprite");
		p_file->store_line("@onready var flame_sprite: Sprite2D = $FlameSprite");
		p_file->store_line("@onready var timer: Timer = $Timer");
		p_file->store_line("");
		p_file->store_line("var is_active: bool = false");
		p_file->store_line("var is_warning: bool = false");
		p_file->store_line("");
		p_file->store_line("func _ready():");
		p_file->store_line("\tsuper._ready()");
		p_file->store_line("\tflame_sprite.visible = false");
		p_file->store_line("\twarning_sprite.visible = false");
		p_file->store_line("\ttimer.timeout.connect(_on_timer_timeout)");
		p_file->store_line("\t_start_cycle()");
		p_file->store_line("");
		p_file->store_line("func _start_cycle():");
		p_file->store_line("\tis_warning = true");
		p_file->store_line("\twarning_sprite.visible = true");
		p_file->store_line("\ttimer.wait_time = warning_time");
		p_file->store_line("\ttimer.start()");
		p_file->store_line("");
		p_file->store_line("func _on_timer_timeout():");
		p_file->store_line("\tif is_warning:");
		p_file->store_line("\t\t_activate_flame()");
		p_file->store_line("\telif is_active:");
		p_file->store_line("\t\t_deactivate_flame()");
		p_file->store_line("\telse:");
		p_file->store_line("\t\t_start_cycle()");
		p_file->store_line("");
		p_file->store_line("func _activate_flame():");
		p_file->store_line("\tis_warning = false");
		p_file->store_line("\tis_active = true");
		p_file->store_line("\twarning_sprite.visible = false");
		p_file->store_line("\tflame_sprite.visible = true");
		p_file->store_line("\tflame_area.body_entered.connect(_on_player_burned)");
		p_file->store_line("\ttimer.wait_time = flame_duration");
		p_file->store_line("\ttimer.start()");
		p_file->store_line("");
		p_file->store_line("func _deactivate_flame():");
		p_file->store_line("\tis_active = false");
		p_file->store_line("\tflame_sprite.visible = false");
		p_file->store_line("\tif flame_area.body_entered.is_connected(_on_player_burned):");
		p_file->store_line("\t\tflame_area.body_entered.disconnect(_on_player_burned)");
		p_file->store_line("\ttimer.wait_time = flame_cooldown");
		p_file->store_line("\ttimer.start()");
		p_file->store_line("");
		p_file->store_line("func _on_player_burned(body: Node):");
		p_file->store_line("\tif body.has_method(\"take_damage\") and body.has_method(\"apply_status_effect\"):");
		p_file->store_line("\t\tbody.take_damage(flame_damage)");
		p_file->store_line("\t\tbody.apply_status_effect(\"burn\", 3.0)");
	} else if (filename == "ClimbableSurface.gd") {
		p_file->store_line("# ClimbableSurface.gd");
		p_file->store_line("# Generated by Lupine Engine - Climbable Surface");
		p_file->store_line("# Ladders, ropes, and climbable walls");
		p_file->store_line("");
		p_file->store_line("extends Area2D");
		p_file->store_line("class_name ClimbableSurface");
		p_file->store_line("");
		p_file->store_line("@export var surface_type: String = \"ladder\"  # ladder, rope, wall");
		p_file->store_line("@export var climb_speed_modifier: float = 0.7");
		p_file->store_line("@export var auto_snap: bool = true");
		p_file->store_line("");
		p_file->store_line("signal player_started_climbing(player: Node)");
		p_file->store_line("signal player_stopped_climbing(player: Node)");
		p_file->store_line("");
		p_file->store_line("func _ready():");
		p_file->store_line("\tbody_entered.connect(_on_player_entered)");
		p_file->store_line("\tbody_exited.connect(_on_player_exited)");
		p_file->store_line("");
		p_file->store_line("func _on_player_entered(body: Node):");
		p_file->store_line("\tif body.has_method(\"start_climbing\"):");
		p_file->store_line("\t\tbody.start_climbing(self)");
		p_file->store_line("\t\tplayer_started_climbing.emit(body)");
		p_file->store_line("");
		p_file->store_line("func _on_player_exited(body: Node):");
		p_file->store_line("\tif body.has_method(\"stop_climbing\"):");
		p_file->store_line("\t\tbody.stop_climbing()");
		p_file->store_line("\t\tplayer_stopped_climbing.emit(body)");
	}
}

void PlatformerElementsModule::generate_scene(Ref<FileAccess> p_file, const String &p_scene_name) {
	if (p_scene_name == "SpikeTile") {
		p_file->store_line("[gd_scene load_steps=3 format=3 uid=\"uid://spike_tile\"]");
		p_file->store_line("");
		p_file->store_line("[ext_resource type=\"Script\" path=\"res://scripts/platformer/SpikeTile.gd\" id=\"1_spike_script\"]");
		p_file->store_line("");
		p_file->store_line("[sub_resource type=\"RectangleShape2D\" id=\"RectangleShape2D_1\"]");
		p_file->store_line("size = Vector2(32, 32)");
		p_file->store_line("");
		p_file->store_line("[sub_resource type=\"RectangleShape2D\" id=\"RectangleShape2D_2\"]");
		p_file->store_line("size = Vector2(28, 16)");
		p_file->store_line("");
		p_file->store_line("[node name=\"SpikeTile\" type=\"StaticBody2D\"]");
		p_file->store_line("script = ExtResource(\"1_spike_script\")");
		p_file->store_line("");
		p_file->store_line("[node name=\"Sprite2D\" type=\"Sprite2D\" parent=\".\"]");
		p_file->store_line("modulate = Color(0.8, 0.3, 0.3, 1)");
		p_file->store_line("scale = Vector2(32, 32)");
		p_file->store_line("");
		p_file->store_line("[node name=\"CollisionShape2D\" type=\"CollisionShape2D\" parent=\".\"]");
		p_file->store_line("shape = SubResource(\"RectangleShape2D_1\")");
		p_file->store_line("");
		p_file->store_line("[node name=\"DamageArea\" type=\"Area2D\" parent=\".\"]");
		p_file->store_line("");
		p_file->store_line("[node name=\"DamageShape\" type=\"CollisionShape2D\" parent=\"DamageArea\"]");
		p_file->store_line("position = Vector2(0, -8)");
		p_file->store_line("shape = SubResource(\"RectangleShape2D_2\")");
	} else if (p_scene_name == "BouncePlate") {
		p_file->store_line("[gd_scene load_steps=4 format=3 uid=\"uid://bounce_plate\"]");
		p_file->store_line("");
		p_file->store_line("[ext_resource type=\"Script\" path=\"res://scripts/platformer/BouncePlate.gd\" id=\"1_bounce_script\"]");
		p_file->store_line("");
		p_file->store_line("[sub_resource type=\"RectangleShape2D\" id=\"RectangleShape2D_1\"]");
		p_file->store_line("size = Vector2(32, 8)");
		p_file->store_line("");
		p_file->store_line("[sub_resource type=\"RectangleShape2D\" id=\"RectangleShape2D_2\"]");
		p_file->store_line("size = Vector2(32, 16)");
		p_file->store_line("");
		p_file->store_line("[sub_resource type=\"Animation\" id=\"Animation_1\"]");
		p_file->store_line("resource_name = \"bounce\"");
		p_file->store_line("length = 0.3");
		p_file->store_line("");
		p_file->store_line("[node name=\"BouncePlate\" type=\"StaticBody2D\"]");
		p_file->store_line("script = ExtResource(\"1_bounce_script\")");
		p_file->store_line("");
		p_file->store_line("[node name=\"Sprite2D\" type=\"Sprite2D\" parent=\".\"]");
		p_file->store_line("modulate = Color(0.3, 1, 0.3, 1)");
		p_file->store_line("scale = Vector2(32, 8)");
		p_file->store_line("");
		p_file->store_line("[node name=\"CollisionShape2D\" type=\"CollisionShape2D\" parent=\".\"]");
		p_file->store_line("shape = SubResource(\"RectangleShape2D_1\")");
		p_file->store_line("");
		p_file->store_line("[node name=\"BounceArea\" type=\"Area2D\" parent=\".\"]");
		p_file->store_line("");
		p_file->store_line("[node name=\"BounceShape\" type=\"CollisionShape2D\" parent=\"BounceArea\"]");
		p_file->store_line("position = Vector2(0, -8)");
		p_file->store_line("shape = SubResource(\"RectangleShape2D_2\")");
		p_file->store_line("");
		p_file->store_line("[node name=\"AudioStreamPlayer2D\" type=\"AudioStreamPlayer2D\" parent=\".\"]");
		p_file->store_line("");
		p_file->store_line("[node name=\"AnimationPlayer\" type=\"AnimationPlayer\" parent=\".\"]");
		p_file->store_line("libraries = {");
		p_file->store_line("\"default\": SubResource(\"Animation_1\")");
		p_file->store_line("}");
	}
}
